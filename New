#include <WiFiS3.h>
#include "DHT.h"

#define DHT_PIN 4
#define DHT_TYPE DHT11

DHT dht(DHT_PIN, DHT_TYPE);

const char* ssid = "Arduino_AP";      // Access Point SSID
const char* password = "12345678";   // Access Point Password

WiFiServer server(80);

void setup() {
  Serial.begin(9600);
  dht.begin();

  // Start WiFi in Access Point mode
  Serial.println("Setting up Access Point...");
  if (!WiFi.beginAP(ssid, password)) {
    Serial.println("Failed to start Access Point");
    while (true);
  }
  Serial.println("Access Point started");
  Serial.print("AP IP Address: ");
  Serial.println(WiFi.localIP()); // Get the IP address of the AP

  // Start the web server
  server.begin();
  Serial.println("Web server started");
}

void loop() {
  WiFiClient client = server.available();
  if (client) {
    Serial.println("Client connected");
    String request = client.readStringUntil('\r');
    client.flush();

    if (request.indexOf("GET /update") >= 0) {
      Serial.println("Update request received");

      // Read DHT11 data
      float humidity = dht.readHumidity();
      float temperature = dht.readTemperature();

      // Check if data is valid
      if (isnan(humidity) || isnan(temperature)) {
        Serial.println("Failed to read from DHT sensor");
        client.println("HTTP/1.1 500 Internal Server Error");
        client.println("Content-Type: text/plain");
        client.println();
        client.println("Failed to read from DHT sensor");
        client.stop();
        return;
      }

      client.println("HTTP/1.1 200 OK");
      client.println("Content-Type: application/json");
      client.println();
      client.print("{\"temperature\": ");
      client.print(temperature);
      client.print(", \"humidity\": ");
      client.print(humidity);
      client.println("}");
    } else if (request.indexOf("POST /save") >= 0) {
      // Handle the save button click (POST request to save data)
      String temperatureData = getSensorData("temperature");
      String humidityData = getSensorData("humidity");

      // Assuming you have a script set up to accept the data and store it in Google Sheets
      sendToGoogleSheets(temperatureData, humidityData);

      // Respond to the client
      client.println("HTTP/1.1 200 OK");
      client.println("Content-Type: text/html");
      client.println();
      client.println("<html><body><h1>Data Saved!</h1></body></html>");
    } else {
      String htmlPage = "<!DOCTYPE html>"
                        "<html>"
                        "<head>"
                        "<title>Sensor Data</title>"
                        "<style>"
                        "* { margin: 0; padding: 0; box-sizing: border-box; }"
                        "p { margin-top: 2em; text-align: left; margin-left: 2em; font-size: 30px; }"
                        "h1 { text-align: center; font-size: 3.5em; color: white; background-color: #333; }"
                        ".main-nav { background-color: #333; padding: 20px 0; }"
                        ".navbar-nav { list-style-type: none; display: flex; justify-content: center; margin: 0; }"
                        ".navbar-nav li { margin: 0 15px; }"
                        ".navbar-nav a { text-decoration: none; color: white; padding: 10px 20px; font-size: 1.2em; border-radius: 5px; transition: background-color 0.3s ease; }"
                        ".navbar-nav a:hover { background-color: #575757; }"
                        ".navbar-nav .active { background-color: #04AA6D; }"
                        ".large-text {font-size: 2em; text-align: center; margin-top: 10px;}"
                        "</style>"
                        "<script>"
                        "function updateData() {"
                        "  fetch('/update')"
                        "    .then(response => response.json())"
                        "    .then(data => {"
                        "      document.getElementById('temp').innerText = data.temperature + 'C';"
                        "      document.getElementById('humi').innerText = data.humidity + '%';"
                        "    })"
                        "    .catch(error => console.error('Error fetching data:', error));"
                        "} "

                        "function saveData() {"
                        "  fetch('/save', { method: 'POST' })"
                        "    .then(response => response.text())"
                        "    .then(data => alert('Data saved!'));"
                        "}"

                        // delete
                        "function saveToGoogleSheets() {"
                        "  if (!randomNumber) {"
                        "    alert("Please generate a number first!");"
                        "    return;"
                        "  } else {"
                        "    fetch("/", {"
                        "      method: "POST","
                        "      headers: { "Content-Type": "application/json" },"
                        "      body: JSON.stringify({ randomNumber }),"
                        "    })"
                        "      .then((response) => response.text())"
                        "      .then((data) => {"
                        "        alert(data);"
                        "      })"
                        "      .catch((error) => {"
                        "        alert("Error: " + error.message);"
                        "      });"
                        "  }"



                        "</script>"
                        "</head>"
                        "<body>"
                        "<header>"
                        "<h1>Attic Robot</h1>"
                        "</header>"
                        "<nav class='main-nav'>"
                        "<ul class='navbar-nav'>"
                        "<li><a>Homepage</a></li>"
                        "<li><a href='features.html'>Features</a></li>"
                        "<li><a>Remote Car Control</a></li>"
                        "<li><a class='active'>Sensors</a></li>"
                        "<li><a href='process.html'>Design Process</a></li>"
                        "<li><a href='gallery.html'>Gallery</a></li>"
                        "<li><a href='improvements.html'>Future Improvements</a></li>"
                        "<li><a href='contact.html'>Contact Page</a></li>"
                        "</ul>"
                        "</nav>"
                        "<p class='large-text'>Temperature and Humidity</p>"
                        // "<p>Temperature: <span id='temp'>-- Â°C</span></p>"
                        "<p>Temperature: <span id='temp'>--</span></p>"
                        // "<p>Humidity: <span id='humi'>-- %</span></p>"
                        "<p>Humidity: <span id='humi'>--</span></p>"
                        // "<button onclick='updateData()'>Update</button>"
                        "<button onclick='updateData()' style='font-size: 1.5em; padding: 15px 30px; margin-top: 20px; vertical-align: top; margin-right: 30px; display: inline-block;'>Update</button>"
                        "<button onclick="saveData()">Save to Google Sheets</button>"
                        "</body>"
                        "</html>";

      // Send response to client
      client.println("HTTP/1.1 200 OK");
      client.println("Content-Type: text/html");
      client.println();
      client.println(htmlPage);
    }

    // Confirm client disconnected
    client.stop();
    Serial.println("Client disconnected");
  }
}

// Function to get sensor data as a string
String getSensorData(String type) {
  float value;
  if (type == "temperature") {
    value = dht.readTemperature();
  } else if (type == "humidity") {
    value = dht.readHumidity();
  }
  
  return String(value);
}

// Function to send data to Google Sheets
void sendToGoogleSheets(String temp, String humi) {
  // Replace with your web app URL
  const char* googleScriptURL = "https://script.google.com/macros/s/AKfycbzkufn1tulBGjNzcANy0nWChirLihsiXL4FUkUPI5Wu5PzTV09XId0OTyjIANuzoS0/exec";

  WiFiClient client;
  if (client.connect(googleScriptURL, 80)) {
    String data = "temperature=" + temp + "&humidity=" + humi;
    client.println("POST /exec HTTP/1.1");
    client.println("Host: script.google.com");
    client.println("Content-Type: application/x-www-form-urlencoded");
    client.println("Content-Length: " + String(data.length()));
    client.println();
    client.print(data);
    client.stop();
  }
}
